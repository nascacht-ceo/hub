name: _test
on:
  workflow_call:
    inputs:
      configuration:
        type: string
        default: Debug

jobs:
  test:
    runs-on: ubuntu-latest
    # This job needs LocalStack
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
          - 4510-4559:4510-4559
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
      
      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj*', '**/Directory.Build.props') }}

      - name: Run Tests
        # We don't map every secret here. 
        # Because we use 'secrets: inherit' in the caller, 
        # all repo secrets starting with 'nc_hub__' are already in the env.
        run: dotnet test --configuration ${{ inputs.configuration }} --no-build --logger "console;verbosity=detailed"
        env:
          # If you have specific non-secret env vars for tests, add them here
          ASPNETCORE_ENVIRONMENT: Development